<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aventura Navide√±a: D√≠a Nevado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Mountains+of+Christmas:wght@700&family=Nunito:wght@400;800&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background-color: #87CEEB; font-family: 'Nunito', sans-serif; user-select: none; }
        .font-xmas { font-family: 'Mountains of Christmas', cursive; }
        
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        /* Paneles Estilo D√≠a (M√°s claros y brillantes) */
        .glass-panel {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(12px);
            border: 2px solid rgba(255, 255, 255, 0.8);
            border-radius: 1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            pointer-events: auto;
            color: #0f172a;
        }

        .btn-start {
            background: linear-gradient(to bottom, #ef4444, #dc2626);
            border: 4px solid white;
            color: white;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4);
            transition: all 0.2s;
        }
        .btn-start:hover { transform: scale(1.05); }
        .btn-start:active { transform: scale(0.95); }
    </style>
</head>
<body>

    <!-- Contenedor 3D -->
    <div id="canvas-container" class="absolute inset-0 z-0"></div>

    <!-- UI LAYER -->
    <div id="ui-layer" class="z-10 flex flex-col justify-between p-4 md:p-6">
        
        <!-- HUD Superior -->
        <div id="hud" class="hidden flex justify-between items-start w-full">
            <!-- Vidas -->
            <div class="glass-panel p-3 flex items-center gap-2 min-w-[100px]">
                <span class="text-xs text-blue-900 uppercase font-bold">Vidas</span>
                <div id="heartsDisplay" class="text-2xl tracking-widest text-red-600">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
            </div>

            <!-- Problema Matem√°tico (Central) -->
            <div class="absolute left-1/2 transform -translate-x-1/2 top-4 w-auto">
                <div class="glass-panel px-10 py-4 border-t-4 border-yellow-500 text-center shadow-lg bg-white/80">
                    <p class="text-[10px] text-yellow-700 uppercase tracking-[0.3em] mb-1 font-bold">Resuelve</p>
                    <p id="problemDisplay" class="text-6xl font-xmas text-slate-800 font-bold drop-shadow-sm">?</p>
                </div>
            </div>

            <!-- Puntos -->
            <div class="glass-panel p-3 text-right min-w-[100px]">
                <p class="text-xs text-blue-900 uppercase font-bold">Puntos</p>
                <p id="scoreDisplay" class="text-3xl font-xmas text-green-700">0</p>
            </div>
        </div>

        <!-- Botones M√≥viles -->
        <div id="mobileControls" class="hidden md:hidden pointer-events-auto flex justify-between w-full pb-8 px-4 opacity-90">
            <button id="btnLeft" class="w-24 h-24 rounded-full bg-white/30 border-4 border-white backdrop-blur-md text-5xl shadow-xl active:bg-white/50 text-white transition transform active:scale-95">‚¨Ö</button>
            <button id="btnRight" class="w-24 h-24 rounded-full bg-white/30 border-4 border-white backdrop-blur-md text-5xl shadow-xl active:bg-white/50 text-white transition transform active:scale-95">‚û°</button>
        </div>
    </div>

    <!-- PANTALLA DE MEN√ö -->
    <div id="menuScreen" class="absolute inset-0 z-20 flex items-center justify-center bg-sky-200/40 backdrop-blur-md">
        <div class="glass-panel p-10 max-w-lg w-full text-center border-4 border-white shadow-2xl bg-white/60">
            <h1 class="text-7xl font-xmas text-red-600 mb-2 drop-shadow-md">Aventura Polar</h1>
            <p class="text-blue-800 mb-8 text-xl font-bold">¬°Ayuda a Santa en este d√≠a nevado!</p>

            <div class="bg-blue-50 p-4 rounded-xl mb-6 text-sm text-blue-700 border border-blue-200">
                <p>üéÑ <strong>Instrucciones:</strong></p>
                <p>Las operaciones cambiar√°n aleatoriamente.</p>
                <p>¬°Mantente alerta!</p>
            </div>

            <button onclick="Game.start()" class="btn-start w-full py-5 rounded-full text-2xl font-xmas font-bold">
                ‚ñ∂ INICIAR VIAJE
            </button>
        </div>
    </div>

    <!-- PANTALLA GAME OVER -->
    <div id="gameOverScreen" class="hidden absolute inset-0 z-30 flex items-center justify-center bg-white/60 backdrop-blur-md">
        <div class="glass-panel p-10 text-center max-w-sm w-full border-4 border-red-500 shadow-2xl bg-white">
            <h2 class="text-6xl font-xmas text-red-600 mb-4">¬°Oh no!</h2>
            <p class="text-slate-600 mb-6 font-bold">Necesitamos reagruparnos.</p>
            
            <div class="bg-slate-100 rounded-xl p-6 mb-8 border border-slate-200">
                <p class="text-xs uppercase text-slate-500 tracking-widest font-bold">Puntuaci√≥n Final</p>
                <p id="finalScore" class="text-7xl font-xmas text-yellow-500 mt-2">0</p>
            </div>
            <button onclick="location.reload()" class="btn-start w-full py-4 rounded-full text-lg">Jugar Otra Vez</button>
        </div>
    </div>

    <script>
        // --- THREE.JS SETUP ---
        const container = document.getElementById('canvas-container');
        const ui = {
            menu: document.getElementById('menuScreen'),
            game: document.getElementById('hud'),
            gameOver: document.getElementById('gameOverScreen'),
            problem: document.getElementById('problemDisplay'),
            score: document.getElementById('scoreDisplay'),
            hearts: document.getElementById('heartsDisplay'),
            mobile: document.getElementById('mobileControls')
        };

        let scene, camera, renderer;
        let playerGroup, snowSystem;
        let objects = [];
        let clock = new THREE.Clock();
        
        const GameState = {
            playing: false,
            speed: 50,
            lane: 0,
            targetX: 0,
            score: 0,
            lives: 3,
            nextSpawnTimer: 0
        };

        const LANE_WIDTH = 8;
        const SKY_COLOR = 0x87CEEB; // Azul cielo claro
        const FOG_COLOR = 0xE0F7FA; // Blanco neblinoso

        // Materiales
        const mats = {
            red: new THREE.MeshStandardMaterial({ color: 0xdc2626 }),
            gold: new THREE.MeshStandardMaterial({ color: 0xfcd34d, metalness: 0.3, roughness: 0.3 }),
            metal: new THREE.MeshStandardMaterial({ color: 0x94a3b8, metalness: 0.5, roughness: 0.2 }),
            skin: new THREE.MeshStandardMaterial({ color: 0xffccbc }),
            white: new THREE.MeshStandardMaterial({ color: 0xffffff }),
            black: new THREE.MeshStandardMaterial({ color: 0x1e293b }),
            brown: new THREE.MeshStandardMaterial({ color: 0x5d4037 }),
            darkBrown: new THREE.MeshStandardMaterial({ color: 0x3e2723 }),
            noseRed: new THREE.MeshStandardMaterial({ color: 0xff0000 }),
            rope: new THREE.LineBasicMaterial({ color: 0x3e2723, linewidth: 2 })
        };

        function init3D() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(SKY_COLOR);
            // Niebla blanca para d√≠a nevado
            scene.fog = new THREE.FogExp2(FOG_COLOR, 0.015); 

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 12, 30);
            camera.lookAt(0, 0, -15);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            container.appendChild(renderer.domElement);

            // Luces (Configuraci√≥n de D√çA)
            const ambient = new THREE.AmbientLight(0xffffff, 0.6); // Luz ambiental brillante
            scene.add(ambient);
            
            // Sol
            const sun = new THREE.DirectionalLight(0xfffee0, 1.2); // Luz c√°lida
            sun.position.set(50, 80, 50);
            sun.castShadow = true;
            sun.shadow.mapSize.set(2048, 2048);
            sun.shadow.camera.left = -50; sun.shadow.camera.right = 50;
            sun.shadow.camera.top = 50; sun.shadow.camera.bottom = -50;
            sun.shadow.camera.far = 200;
            sun.shadow.bias = -0.0005;
            scene.add(sun);

            // Suelo (Nieve brillante)
            const ground = new THREE.Mesh(new THREE.PlaneGeometry(600, 600), new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.9 }));
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -0.1;
            ground.receiveShadow = true;
            scene.add(ground);

            createPlayerTeam();
            createSnow();

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            animate();
        }

        // --- MODELOS ---
        function createReindeer(isRudolph) {
            const g = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(1.2, 1.4, 2.2), mats.brown); body.position.y = 1.4; body.castShadow = true;
            const neck = new THREE.Mesh(new THREE.BoxGeometry(0.8, 1.2, 0.8), mats.brown); neck.position.set(0, 2.2, 1.2); neck.rotation.x = -0.5;
            const head = new THREE.Mesh(new THREE.BoxGeometry(0.9, 0.9, 1.2), mats.brown); head.position.set(0, 2.8, 1.8); head.castShadow = true;
            const nose = new THREE.Mesh(new THREE.SphereGeometry(0.15), isRudolph ? mats.noseRed : mats.black); nose.position.set(0, 2.8, 2.4);
            const legG = new THREE.BoxGeometry(0.3, 1.4, 0.3);
            const l1=new THREE.Mesh(legG, mats.brown); l1.position.set(-0.4,0.7,0.8); const l2=new THREE.Mesh(legG, mats.brown); l2.position.set(0.4,0.7,0.8);
            const l3=new THREE.Mesh(legG, mats.brown); l3.position.set(-0.4,0.7,-0.8); const l4=new THREE.Mesh(legG, mats.brown); l4.position.set(0.4,0.7,-0.8);
            const antG = new THREE.CylinderGeometry(0.04, 0.04, 1.2);
            const a1=new THREE.Mesh(antG, mats.darkBrown); a1.position.set(-0.4,3.5,1.6); a1.rotation.z=0.5;
            const a2=new THREE.Mesh(antG, mats.darkBrown); a2.position.set(0.4,3.5,1.6); a2.rotation.z=-0.5;
            g.add(body, neck, head, nose, l1, l2, l3, l4, a1, a2);
            return g;
        }

        function createSanta() {
            const g = new THREE.Group();
            const body = new THREE.Mesh(new THREE.SphereGeometry(0.9), mats.red); body.position.y = 0.9;
            const head = new THREE.Mesh(new THREE.SphereGeometry(0.5), mats.skin); head.position.y = 1.9;
            const beard = new THREE.Mesh(new THREE.ConeGeometry(0.5, 0.8, 16), mats.white); beard.position.set(0, 1.6, 0.3); beard.rotation.x = 2.8;
            const hat = new THREE.Mesh(new THREE.ConeGeometry(0.45, 1, 16), mats.red); hat.position.set(0, 2.5, 0); hat.rotation.x = -0.2;
            g.add(body, head, beard, hat);
            return g;
        }

        function createPlayerTeam() {
            playerGroup = new THREE.Group();
            const sleigh = new THREE.Group();
            const base = new THREE.Mesh(new THREE.BoxGeometry(3, 1.2, 5), mats.red); base.position.y = 0.8; base.castShadow = true;
            const goldTrim = new THREE.Mesh(new THREE.BoxGeometry(3.2, 0.2, 5.2), mats.gold); goldTrim.position.y = 1.4;
            const runners = new THREE.Group();
            const r1 = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.2, 6), mats.metal); r1.position.set(-1.2, 0.1, 0);
            const r2 = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.2, 6), mats.metal); r2.position.set(1.2, 0.1, 0);
            runners.add(r1, r2);
            const bag = new THREE.Mesh(new THREE.SphereGeometry(1.6), new THREE.MeshStandardMaterial({color: 0x6b21a8})); bag.position.set(0, 1.8, -1.2);
            sleigh.add(base, goldTrim, runners, bag); playerGroup.add(sleigh);

            const santa = createSanta(); santa.position.set(0, 0.8, 1); playerGroup.add(santa);
            const r1L = createReindeer(false); r1L.position.set(-1.8, 0, 4.5);
            const r1R = createReindeer(false); r1R.position.set(1.8, 0, 4.5);
            const r2L = createReindeer(false); r2L.position.set(-1.8, 0, 8.5);
            const r2R = createReindeer(true);  r2R.position.set(1.8, 0, 8.5);
            playerGroup.add(r1L, r1R, r2L, r2R);
            scene.add(playerGroup);
        }

        function createSnow() {
            const count = 3000;
            const geo = new THREE.BufferGeometry();
            const pos = new Float32Array(count * 3);
            for(let i=0; i<count*3; i++) pos[i] = (Math.random()-0.5)*150;
            geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
            snowSystem = new THREE.Points(geo, new THREE.PointsMaterial({color:0xffffff, size:0.3, transparent:true}));
            scene.add(snowSystem);
        }

        // --- L√ìGICA DE JUEGO ---

        const Game = {
            start: () => {
                GameState.playing = true;
                GameState.lives = 3;
                GameState.score = 0;
                GameState.speed = 50;
                GameState.lane = 0;
                playerGroup.position.set(0,0,0);
                GameState.targetX = 0;
                
                objects.forEach(o => scene.remove(o));
                objects = [];
                
                ui.menu.classList.add('hidden');
                ui.game.classList.remove('hidden');
                ui.mobile.classList.remove('hidden');
                ui.gameOver.classList.add('hidden');
                
                updateUI();
                generateLevel();
            },
            move: (dir) => {
                const l = GameState.lane + dir;
                if(l >= -1 && l <= 1) { GameState.lane = l; GameState.targetX = l * LANE_WIDTH; }
            }
        };

        function generateLevel() {
            // SELECCI√ìN ALEATORIA DE MODO
            const modes = ['sum', 'sub', 'mul', 'div'];
            const mode = modes[Math.floor(Math.random() * modes.length)];

            let n1, n2, ans, txt;
            if(mode === 'sum') { n1=r(2,15); n2=r(2,10); ans=n1+n2; txt=`${n1} + ${n2}`; }
            else if(mode === 'sub') { n1=r(10,30); n2=r(2,n1-2); ans=n1-n2; txt=`${n1} - ${n2}`; }
            else if(mode === 'mul') { n1=r(2,9); n2=r(2,5); ans=n1*n2; txt=`${n1} √ó ${n2}`; }
            else { let f1=r(2,9), f2=r(2,6); n1=f1*f2; n2=f1; ans=f2; txt=`${n1} √∑ ${n2}`; }

            ui.problem.innerText = txt;

            let opts = [ans];
            while(opts.length < 3) { let x = ans + r(-5, 5); if(x>=0 && !opts.includes(x)) opts.push(x); }
            opts.sort(() => Math.random()-0.5);

            const zPos = -120;
            opts.forEach((val, i) => {
                createGate(val, (i-1)*LANE_WIDTH, zPos, val === ans);
            });
        }

        function createGate(val, x, z, correct) {
            const g = new THREE.Group();
            const torus = new THREE.Mesh(new THREE.TorusGeometry(2.5, 0.5, 8, 20), new THREE.MeshStandardMaterial({color: 0x15803d})); g.add(torus);
            const cvs = document.createElement('canvas'); cvs.width=256; cvs.height=256;
            const ctx = cvs.getContext('2d');
            ctx.beginPath(); ctx.arc(128,128,110,0,Math.PI*2); ctx.fillStyle='#fef9c3'; ctx.fill();
            ctx.fillStyle='#422006'; ctx.font='bold 140px Arial'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(val,128,128);
            const sprite = new THREE.Sprite(new THREE.SpriteMaterial({map: new THREE.CanvasTexture(cvs)})); sprite.scale.set(3,3,1); g.add(sprite);
            g.position.set(x, 2.5, z); g.userData = { type: 'gate', correct: correct, active: true };
            scene.add(g); objects.push(g);
        }

        function createDecoTree(x, z) {
            const g = new THREE.Group();
            const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.4, 1.5), mats.darkBrown); trunk.position.y=0.75;
            const leaves = new THREE.Mesh(new THREE.ConeGeometry(1.5, 4, 8), new THREE.MeshStandardMaterial({color: 0x064e3b})); leaves.position.y=2.75;
            const snow = new THREE.Mesh(new THREE.ConeGeometry(0.8, 1, 8), mats.white); snow.position.y=4.2;
            g.add(trunk, leaves, snow); g.position.set(x, 0, z); g.userData = { type: 'deco' };
            scene.add(g); objects.push(g);
        }

        function animate() {
            requestAnimationFrame(animate);
            const dt = clock.getDelta();

            // Nieve
            const pos = snowSystem.geometry.attributes.position.array;
            for(let i=1; i<pos.length; i+=3) { pos[i] -= 10*dt; if(pos[i]<0) pos[i]=80; }
            snowSystem.geometry.attributes.position.needsUpdate = true;
            snowSystem.rotation.y += 0.05 * dt;

            if(GameState.playing) {
                playerGroup.position.x += (GameState.targetX - playerGroup.position.x) * 6 * dt;
                playerGroup.rotation.z = (playerGroup.position.x - GameState.targetX) * 0.03;
                playerGroup.rotation.x = Math.sin(Date.now()*0.005) * 0.05;

                const speed = GameState.speed * dt;
                for(let i=objects.length-1; i>=0; i--) {
                    let o = objects[i];
                    o.position.z += speed;
                    if(o.userData.type === 'gate') {
                        if(o.userData.active && o.position.z > 4 && o.position.z < 8) {
                            if(Math.abs(o.position.x - playerGroup.position.x) < 2.5) handleCollision(o);
                        }
                    }
                    if(o.position.z > 35) { scene.remove(o); objects.splice(i, 1); }
                }

                GameState.nextSpawnTimer += dt;
                if(GameState.nextSpawnTimer > 0.15) {
                    const side = Math.random()>0.5 ? 1 : -1;
                    createDecoTree((Math.random()*30 + 15)*side, -150);
                    GameState.nextSpawnTimer = 0;
                }

                const gatesInScene = objects.filter(o => o.userData.type === 'gate' && o.position.z < 10);
                if(gatesInScene.length === 0) generateLevel();

            } else {
                camera.position.x = Math.sin(Date.now()*0.0005) * 10;
                camera.lookAt(0, 5, -10);
            }
            renderer.render(scene, camera);
        }

        function handleCollision(gate) {
            gate.userData.active = false; gate.visible = false;
            if(gate.userData.correct) {
                GameState.score += 100; GameState.speed += 2; ui.problem.style.color = '#16a34a';
            } else {
                GameState.lives--; ui.problem.style.color = '#dc2626';
                if(GameState.lives <= 0) gameOver();
            }
            setTimeout(() => ui.problem.style.color = '#1e293b', 500);
            updateUI();
        }

        function updateUI() { ui.score.innerText = GameState.score; ui.hearts.innerText = "‚ù§Ô∏è".repeat(GameState.lives); }
        function gameOver() {
            GameState.playing = false; ui.game.classList.add('hidden'); ui.mobile.classList.add('hidden'); ui.gameOver.classList.remove('hidden');
            document.getElementById('finalScore').innerText = GameState.score;
        }
        function r(min, max) { return Math.floor(Math.random()*(max-min+1))+min; }
        
        window.addEventListener('keydown', e => { if(GameState.playing) { if(e.key==='ArrowLeft') Game.move(-1); if(e.key==='ArrowRight') Game.move(1); } });
        document.getElementById('btnLeft').addEventListener('click', () => Game.move(-1));
        document.getElementById('btnRight').addEventListener('click', () => Game.move(1));

        init3D();
    </script>
</body>
</html>

